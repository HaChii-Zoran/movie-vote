<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©å›½ç”µå½±æŠ•ç¥¨</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; }
        
        /* æŠ•ç¥¨è¡¨å•åŒºåŸŸ */
        .vote-section { background: #eef2f7; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .veto-input { border-color: #ff6b6b; background-color: #fff0f0; }
        
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #0056b3; }
        
        /* ç»“æœå±•ç¤ºè¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #666; font-size: 14px; }
        
        /* ç‰¹æ®ŠçŠ¶æ€æ ·å¼ */
        .rank-1 { color: #d35400; font-weight: bold; } /* ç¬¬ä¸€åé¢œè‰² */
        .veto-dead { text-decoration: line-through; color: #999; background-color: #ffe6e6; } /* è¢«æ·˜æ±° */
        .veto-badge { background: #ff4757; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .overlap-badge { background: #2ed573; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }

        .rules { font-size: 12px; color: #666; background: #fff8e1; padding: 10px; border-radius: 6px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¬ å¤©å›½ç”µå½±VOTE</h1>
    
    <div class="rules">
        <strong>è®¡åˆ†è§„åˆ™ï¼š</strong>ç¬¬1å¿—æ„¿=3åˆ†ï¼Œç¬¬2å¿—æ„¿=2åˆ†ï¼Œç¬¬3å¿—æ„¿=1åˆ†ã€‚<br>
        <strong>æ·˜æ±°è§„åˆ™ï¼š</strong>ä»»æ„ç”µå½±æ”¶åˆ° â‰¥2 ä¸ª Veto ç›´æ¥æ·˜æ±°ã€‚<br>
        <strong>è·èƒœåˆ¤å®šï¼š</strong>ä¼˜å…ˆçœ‹â€œå¤šäººæåâ€çš„é«˜åˆ†ç”µå½±ï¼›æ— é‡åˆåˆ™å– Top3 è¿›äºŒè½®ã€‚
    </div>

    <div class="vote-section">
        <h3>ğŸ“ å¡«å†™é€‰ç¥¨</h3>
        <div class="input-group">
            <label>ä½ çš„åå­—</label>
            <input type="text" id="voterName" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰">
        </div>
        <div class="input-group">
            <label>â¤ï¸ ç¬¬ä¸€å¿—æ„¿ (3åˆ†)</label>
            <input type="text" id="movie1" placeholder="æœ€æƒ³çœ‹çš„">
        </div>
        <div class="input-group">
            <label>ğŸ’™ ç¬¬äºŒå¿—æ„¿ (2åˆ†)</label>
            <input type="text" id="movie2" placeholder="æƒ³çœ‹çš„">
        </div>
        <div class="input-group">
            <label>ğŸ’› ç¬¬ä¸‰å¿—æ„¿ (1åˆ†)</label>
            <input type="text" id="movie3" placeholder="ä¹Ÿå¯ä»¥çš„">
        </div>
        <div class="input-group">
            <label style="color:#d63031">ğŸš« åå‘ä¿æŠ¤ Veto (å¯é€‰)</label>
            <input type="text" id="movieVeto" class="veto-input" placeholder="å¦‚æœæœ‰â‰¥2äººå¡«æ­¤ç‰‡ï¼Œåˆ™ç›´æ¥æ·˜æ±°">
        </div>
        <button onclick="submitBallot()">æäº¤é€‰ç¥¨</button>
    </div>

    <hr>

    <h2>ğŸ“Š å®æ—¶æˆ˜å†µ</h2>
    <p id="status">æ­£åœ¨åŠ è½½...</p>
    <table id="resultTable">
        <thead>
            <tr>
                <th>æ’å</th>
                <th>ç”µå½±å</th>
                <th>æ€»åˆ†</th>
                <th>æåäººæ•°</th>
                <th>Vetoæ•°</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>
    
    <div style="margin-top:20px; text-align:center;">
        <small style="color:#999">è¯·ç¡®ä¿å¤§å®¶è¾“å…¥çš„ç”µå½±åå®Œå…¨ä¸€è‡´ï¼ˆæ¨èå¤åˆ¶ç²˜è´´ï¼‰</small>
    </div>
</div>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    const APP_ID = 'LUMZuF5Cr3LjaCLSeyoYnvnS-MdYXbMMI'; 
    const APP_KEY = 'rYU63S7qKIqPcjeHdXwfnSca';
    const SERVER_URL = 'https://lumzuf5c.api.lncldglobal.com';

    AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });

    // ================= é€»è¾‘ä»£ç  =================

    // æäº¤é€‰ç¥¨
    async function submitBallot() {
        const name = document.getElementById('voterName').value.trim();
        const m1 = document.getElementById('movie1').value.trim();
        const m2 = document.getElementById('movie2').value.trim();
        const m3 = document.getElementById('movie3').value.trim();
        const veto = document.getElementById('movieVeto').value.trim();

        if(!name || !m1 || !m2 || !m3) {
            alert("è¯·å¡«å†™å®Œæ•´åå­—å’Œå‰ä¸‰éƒ¨ç”µå½±ï¼");
            return;
        }

        const Ballot = AV.Object.extend('Ballot');
        const ballot = new Ballot();
        ballot.set('voter', name);
        ballot.set('rank1', m1);
        ballot.set('rank2', m2);
        ballot.set('rank3', m3);
        ballot.set('veto', veto);

        try {
            await ballot.save();
            alert("æäº¤æˆåŠŸï¼");
            // æ¸…ç©ºè¾“å…¥æ¡†é˜²æ­¢é‡å¤æäº¤
            document.querySelectorAll('input').forEach(i => i.value = '');
            loadResults(); // åˆ·æ–°ç»“æœ
        } catch (error) {
            alert("æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼š" + error.message);
        }
    }

    // æ‹‰å–æ•°æ®å¹¶è®¡ç®—
    async function loadResults() {
        document.getElementById('status').innerText = "è®¡ç®—ä¸­...";
        const query = new AV.Query('Ballot');
        // è·å–æ‰€æœ‰äººçš„æŠ•ç¥¨
        const ballots = await query.find();
        
        // 1. åŸå§‹æ•°æ®ç»Ÿè®¡å­—å…¸
        let stats = {}; 

        // è¾…åŠ©å‡½æ•°ï¼šåˆå§‹åŒ–ç”µå½±å¯¹è±¡
        function initMovie(name) {
            if (!name) return;
            if (!stats[name]) {
                stats[name] = { score: 0, voters: new Set(), vetos: 0, name: name };
            }
        }

        // 2. éå†æ¯ä¸€å¼ é€‰ç¥¨è¿›è¡Œè®¡ç®—
        ballots.forEach(b => {
            const m1 = b.get('rank1');
            const m2 = b.get('rank2');
            const m3 = b.get('rank3');
            const v = b.get('veto');
            const voter = b.get('voter');

            // è®¡åˆ† (3/2/1)
            if(m1) { initMovie(m1); stats[m1].score += 3; stats[m1].voters.add(voter); }
            if(m2) { initMovie(m2); stats[m2].score += 2; stats[m2].voters.add(voter); }
            if(m3) { initMovie(m3); stats[m3].score += 1; stats[m3].voters.add(voter); }
            
            // è®° Veto
            if(v) { 
                // æ³¨æ„ï¼šè¢«Vetoçš„ç”µå½±å¯èƒ½æ²¡è¢«æåï¼Œä¹Ÿè¦è®°å½•ä¸‹æ¥
                initMovie(v); 
                stats[v].vetos += 1; 
            }
        });

        // 3. è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
        let results = Object.values(stats);
        
        // æ’åºé€»è¾‘ï¼š
        // 1. ä¼˜å…ˆæŠŠæ²¡è¢«æ·˜æ±°çš„æ”¾å‰é¢ (Veto < 2)
        // 2. ç„¶åæŒ‰åˆ†æ•°é«˜ä½æ’
        // 3. åˆ†æ•°ä¸€æ ·ï¼ŒæŒ‰æåäººæ•°å¤šæ’
        results.sort((a, b) => {
            const aDead = a.vetos >= 2;
            const bDead = b.vetos >= 2;
            if (aDead && !bDead) return 1; // aæ­»äº†ï¼Œbæ’å‰é¢
            if (!aDead && bDead) return -1;
            
            if (b.score !== a.score) return b.score - a.score; // åˆ†æ•°é™åº
            return b.voters.size - a.voters.size; // æåäººæ•°é™åº
        });

        renderTable(results);
        document.getElementById('status').innerText = `å·²æ”¶åˆ° ${ballots.length} äººæŠ•ç¥¨`;
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        data.forEach((movie, index) => {
            const isDead = movie.vetos >= 2; // æ˜¯å¦è¢«æ·˜æ±°
            const isOverlap = movie.voters.size >= 2; // æ˜¯å¦å¤šäººæå
            
            let rowClass = '';
            let nameDisplay = movie.name;
            
            // æ ·å¼å¤„ç†
            if (isDead) {
                rowClass = 'veto-dead';
                nameDisplay += ' (å·²æ·˜æ±°)';
            } else if (index === 0) {
                rowClass = 'rank-1'; // ç¬¬ä¸€åé«˜äº®
            }

            const tr = document.createElement('tr');
            tr.className = rowClass;
            
            tr.innerHTML = `
                <td>${isDead ? '-' : index + 1}</td>
                <td style="text-align:left; padding-left:20px;">
                    ${nameDisplay}
                    ${isOverlap && !isDead ? '<span class="overlap-badge">å…±è¯†</span>' : ''}
                </td>
                <td>${movie.score}</td>
                <td>${movie.voters.size}äºº</td>
                <td>${movie.vetos > 0 ? `<span class="veto-badge">${movie.vetos} veto</span>` : '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // å¯åŠ¨æ—¶åŠ è½½ä¸€æ¬¡
    loadResults();
    // æ¯3ç§’è‡ªåŠ¨åˆ·æ–°çœ‹ç»“æœ
    setInterval(loadResults, 3000);

</script>
</body>
</html>
