<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©å›½ç”µå½±æŠ•ç¥¨</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; }
        
        /* æŠ•ç¥¨è¡¨å• */
        .vote-section { background: #eef2f7; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .veto-input { border-color: #ff6b6b; background-color: #fff0f0; }
        
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #0056b3; }
        
        /* ç›²ç›’åŒºåŸŸæ ·å¼ */
        .blind-box { text-align: center; padding: 40px 20px; background: #fff8e1; border-radius: 8px; border: 2px dashed #ffc107; margin-top: 20px; }
        .vote-count { font-size: 48px; font-weight: bold; color: #d35400; margin: 10px 0; }
        .reveal-btn { background-color: #27ae60; margin-top: 15px; width: auto; padding: 10px 40px; }
        
        /* ç»“æœè¡¨æ ¼ï¼ˆé»˜è®¤éšè—ï¼‰ */
        #resultArea { display: none; animation: fadeIn 0.5s; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #666; font-size: 14px; }
        .rank-1 { color: #d35400; font-weight: bold; background-color: #fffaf0; }
        .veto-dead { text-decoration: line-through; color: #999; background-color: #ffe6e6; }
        .overlap-badge { background: #2ed573; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .veto-badge { background: #ff4757; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¬ å¤©å›½ç”µå½±VOTE</h1>
    
    <div class="vote-section">
        <h3>ğŸ“ å¡«å†™é€‰ç¥¨</h3>
        <div class="input-group">
            <label>ä½ çš„åå­—</label>
            <input type="text" id="voterName" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰">
        </div>
        <div class="input-group">
            <label>â¤ï¸ ç¬¬ä¸€å¿—æ„¿ (3åˆ†)</label>
            <input type="text" id="movie1" placeholder="æœ€æƒ³çœ‹çš„">
        </div>
        <div class="input-group">
            <label>ğŸ’™ ç¬¬äºŒå¿—æ„¿ (2åˆ†)</label>
            <input type="text" id="movie2" placeholder="æƒ³çœ‹çš„">
        </div>
        <div class="input-group">
            <label>ğŸ’› ç¬¬ä¸‰å¿—æ„¿ (1åˆ†)</label>
            <input type="text" id="movie3" placeholder="ä¹Ÿå¯ä»¥çš„">
        </div>
        <div class="input-group">
            <label style="color:#d63031">ğŸš« åå‘ä¿æŠ¤ Veto (å¯é€‰)</label>
            <input type="text" id="movieVeto" class="veto-input" placeholder="æœ‰â‰¥2äººå¡«æ­¤ç‰‡åˆ™ç›´æ¥æ·˜æ±°">
        </div>
        <button onclick="submitBallot()">æäº¤é€‰ç¥¨ (æäº¤åè¯·ä¿å¯†)</button>
    </div>

    <hr>

    <div id="blindState" class="blind-box">
        <h3>ğŸ—³ï¸ æŠ•ç¥¨è¿›è¡Œä¸­...</h3>
        <div>å½“å‰å·²æ”¶åˆ°</div>
        <div class="vote-count" id="countNum">0</div>
        <div>å¼ é€‰ç¥¨</div>
        <br>
        <p style="color:#666; font-size:14px;">ç»“æœå·²éšè—ï¼Œç­‰å¾…å…¨å‘˜æŠ•å®Œ</p>
        <button class="reveal-btn" onclick="reveal()">ğŸ‘€ æ‰€æœ‰äººæŠ•å®Œåï¼Œç‚¹æ­¤æ­æ™“</button>
    </div>

    <div id="resultArea">
        <h2>ğŸ“Š æœ€ç»ˆæˆ˜å†µ</h2>
        <table id="resultTable">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>ç”µå½±å</th>
                    <th>æ€»åˆ†</th>
                    <th>æåäººæ•°</th>
                    <th>Vetoæ•°</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <button onclick="hideResults()" style="background:#999; margin-top:20px;">ğŸ™ˆ éšè—ç»“æœ</button>
    </div>
</div>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    const APP_ID = 'LUMZuF5Cr3LjaCLSeyoYnvnS-MdYXbMMI'; 
    const APP_KEY = 'rYU63S7qKIqPcjeHdXwfnSca';
    const SERVER_URL = 'https://lumzuf5c.api.lncldglobal.com'; 

    AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });

    // å…¨å±€å˜é‡å­˜å‚¨æ•°æ®
    let globalResults = []; 
    let isRevealed = false; // æ ‡è®°æ˜¯å¦å·²ç»æ­æ™“

    // æäº¤é€‰ç¥¨
    async function submitBallot() {
        const name = document.getElementById('voterName').value.trim();
        const m1 = document.getElementById('movie1').value.trim();
        const m2 = document.getElementById('movie2').value.trim();
        const m3 = document.getElementById('movie3').value.trim();
        const veto = document.getElementById('movieVeto').value.trim();

        if(!name || !m1 || !m2 || !m3) {
            alert("è¯·å¡«å†™å®Œæ•´åå­—å’Œå‰ä¸‰éƒ¨ç”µå½±ï¼");
            return;
        }

        const Ballot = AV.Object.extend('Ballot');
        // æƒé™è®¾ç½®ï¼šå…è®¸æ‰€æœ‰äººè¯»å†™
        const acl = new AV.ACL();
        acl.setPublicReadAccess(true);
        acl.setPublicWriteAccess(true);

        const ballot = new Ballot();
        ballot.setACL(acl);
        ballot.set('voter', name);
        ballot.set('rank1', m1);
        ballot.set('rank2', m2);
        ballot.set('rank3', m3);
        ballot.set('veto', veto);

        try {
            await ballot.save();
            alert("æäº¤æˆåŠŸï¼è¯·åœ¨ç¾¤é‡Œå›å¤â€œå·²æŠ•â€ï¼Œä½†ä¸è¦é€éœ²å†…å®¹ã€‚");
            document.querySelectorAll('input').forEach(i => i.value = '');
            loadResults(); 
        } catch (error) {
            alert("æäº¤å¤±è´¥ï¼š" + error.message);
        }
    }

    // ç‚¹å‡»â€œæ­æ™“â€æŒ‰é’®
    function reveal() {
        const confirmReveal = confirm("ç¡®å®šæ‰€æœ‰äººéƒ½æŠ•å®Œäº†å—ï¼Ÿ\n\nç‚¹å‡»ç¡®å®šå°†å‘æ‰€æœ‰äººå±•ç¤ºç»“æœã€‚");
        if(confirmReveal) {
            document.getElementById('blindState').style.display = 'none';
            document.getElementById('resultArea').style.display = 'block';
            isRevealed = true;
            renderTable(globalResults); // æ¸²æŸ“åˆšåˆšè®¡ç®—å¥½çš„æ•°æ®
        }
    }

    // é‡æ–°éšè—ï¼ˆå¦‚æœç‚¹é”™äº†ï¼‰
    function hideResults() {
        document.getElementById('blindState').style.display = 'block';
        document.getElementById('resultArea').style.display = 'none';
        isRevealed = false;
    }

    // åå°åŠ è½½æ•°æ®
    async function loadResults() {
        const query = new AV.Query('Ballot');
        const ballots = await query.find();
        
        // æ›´æ–°å¤§æ•°å­—
        document.getElementById('countNum').innerText = ballots.length;

        // è®¡ç®—é€»è¾‘ (å’Œä¹‹å‰ä¸€æ ·ï¼Œåªæ˜¯ç®—å®Œå…ˆä¸ç”»è¡¨æ ¼)
        let stats = {}; 
        function initMovie(name) {
            if (!name) return;
            if (!stats[name]) {
                stats[name] = { score: 0, voters: new Set(), vetos: 0, name: name };
            }
        }

        ballots.forEach(b => {
            const m1 = b.get('rank1');
            const m2 = b.get('rank2');
            const m3 = b.get('rank3');
            const v = b.get('veto');
            const voter = b.get('voter');

            if(m1) { initMovie(m1); stats[m1].score += 3; stats[m1].voters.add(voter); }
            if(m2) { initMovie(m2); stats[m2].score += 2; stats[m2].voters.add(voter); }
            if(m3) { initMovie(m3); stats[m3].score += 1; stats[m3].voters.add(voter); }
            if(v) { initMovie(v); stats[v].vetos += 1; }
        });

        // æ’åº
        let results = Object.values(stats);
        results.sort((a, b) => {
            const aDead = a.vetos >= 2;
            const bDead = b.vetos >= 2;
            if (aDead && !bDead) return 1;
            if (!aDead && bDead) return -1;
            if (b.score !== a.score) return b.score - a.score;
            return b.voters.size - a.voters.size;
        });

        // ä¿å­˜åˆ°å…¨å±€å˜é‡
        globalResults = results;

        // å¦‚æœå½“å‰å·²ç»æ˜¯æ­æ™“çŠ¶æ€ï¼Œå®æ—¶åˆ·æ–°è¡¨æ ¼ï¼ˆå¤„ç†åæ¥çš„äººè¡¥ç¥¨æƒ…å†µï¼‰
        if(isRevealed) {
            renderTable(results);
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        data.forEach((movie, index) => {
            const isDead = movie.vetos >= 2;
            const isOverlap = movie.voters.size >= 2;
            let rowClass = '';
            let nameDisplay = movie.name;
            if (isDead) {
                rowClass = 'veto-dead';
                nameDisplay += ' (å·²æ·˜æ±°)';
            } else if (index === 0) {
                rowClass = 'rank-1';
            }
            const tr = document.createElement('tr');
            tr.className = rowClass;
            tr.innerHTML = `
                <td>${isDead ? '-' : index + 1}</td>
                <td style="text-align:left; padding-left:20px;">
                    ${nameDisplay}
                    ${isOverlap && !isDead ? '<span class="overlap-badge">å…±è¯†</span>' : ''}
                </td>
                <td>${movie.score}</td>
                <td>${movie.voters.size}äºº</td>
                <td>${movie.vetos > 0 ? `<span class="veto-badge">${movie.vetos} veto</span>` : '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // å¯åŠ¨
    loadResults();
    setInterval(loadResults, 3000);
</script>
</body>
</html>
