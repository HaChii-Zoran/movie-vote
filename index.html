<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©å›½ç”µå½±vote</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #f4f4f9; padding: 20px; }
        h1 { color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #chart { width: 100%; height: 300px; margin-top: 20px; }
        .btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; background-color: #007bff; color: white; transition: 0.2s; }
        button:hover { background-color: #0056b3; transform: scale(1.05); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .loading { color: #888; font-size: 14px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ¬ å¤©å›½ç”µå½±æŠ•ç¥¨</h1>
        <p class="loading" id="status">Loading...</p>
        
        <div class="btn-group" id="btnContainer">
            </div>

        <div id="chart"></div>
    </div>

    <script>
        // =========================================================
        // 1. åˆå§‹åŒ–äº‘ç«¯æ•°æ®åº“
        // è¯·å°†ä¸‹é¢çš„å­—ç¬¦ä¸²æ›¿æ¢ä¸ºä½ è‡ªå·±åœ¨ LeanCloud ç”³è¯·çš„ AppID å’Œ AppKey
        // =========================================================
        const APP_ID = 'LUMZuF5Cr3LjaCLSeyoYnvnS-MdYXbMMI'; 
        const APP_KEY = 'rYU63S7qKIqPcjeHdXwfnSca';
        const SERVER_URL = 'https://lumzuf5c.api.lncldglobal.com'; 
        // ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œå¦‚æœå¡«çš„æ˜¯ç©ºçš„ï¼Œä¼šæŠ¥é”™
        if(APP_ID.includes('è¿™é‡Œå¡«') || APP_KEY.includes('è¿™é‡Œå¡«')){
            alert("è¯·å…ˆåœ¨ä»£ç ä¸­å¡«å…¥ä½ çš„ LeanCloud AppID å’Œ AppKeyï¼");
        }

        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURL: SERVER_URL
            });

        // å®šä¹‰ç”µå½±åˆ—è¡¨
        const movieNames = ['æ˜Ÿé™…ç©¿è¶Š', 'ç›—æ¢¦ç©ºé—´', 'æ³°å¦å°¼å…‹å·', 'å¤ä»‡è€…è”ç›Ÿ', 'åƒä¸åƒå¯»'];
        let chartInstance = echarts.init(document.getElementById('chart'));

        // =========================================================
        // 2. æ ¸å¿ƒåŠŸèƒ½å‡½æ•°
        // =========================================================

        // è·å–æˆ–åˆå§‹åŒ–æ•°æ®
        async function loadData() {
            document.getElementById('status').innerText = "æ­£åœ¨åŒæ­¥æ•°æ®...";
            const query = new AV.Query('MovieScores');
            
            try {
                const results = await query.find();
                
                // å¦‚æœäº‘ç«¯æ˜¯ç©ºçš„ï¼ˆç¬¬ä¸€æ¬¡è¿è¡Œï¼‰ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºæ•°æ®
                if (results.length === 0) {
                    await initCloudData();
                    return loadData(); // é‡æ–°åŠ è½½
                }

                // æ•´ç†äº‘ç«¯æ‹¿åˆ°çš„æ•°æ®
                let dataMap = {};
                results.forEach(item => {
                    dataMap[item.get('name')] = {
                        votes: item.get('votes'),
                        id: item.id // è®°ä½è¿™ä¸ªIDï¼ŒæŠ•ç¥¨æ—¶è¦ç”¨
                    };
                });

                // æ›´æ–°å›¾è¡¨
                updateChart(dataMap);
                document.getElementById('status').innerText = "æ•°æ®å·²åŒæ­¥ âœ…";
                return dataMap;
            } catch (error) {
                console.error(error);
                document.getElementById('status').innerText = "è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥AppID";
            }
        }

        // ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼Œåœ¨äº‘ç«¯åˆ›å»º5éƒ¨ç”µå½±çš„æ¡£æ¡ˆ
        async function initCloudData() {
            console.log("åˆå§‹åŒ–äº‘ç«¯æ•°æ®...");
            const MovieScores = AV.Object.extend('MovieScores');
            const promises = movieNames.map(name => {
                const movie = new MovieScores();
                movie.set('name', name);
                movie.set('votes', 0);
                return movie.save();
            });
            await Promise.all(promises);
        }

        // æŠ•ç¥¨åŠ¨ä½œ
        async function vote(movieName, objectId) {
            document.getElementById('status').innerText = `æ­£åœ¨æäº¤ç»™ ${movieName}...`;
            
            // åˆ›å»ºä¸€ä¸ªæŒ‡å‘è¯¥è¡Œæ•°æ®çš„å¼•ç”¨
            const todo = AV.Object.createWithoutData('MovieScores', objectId);
            // åŸå­æ“ä½œï¼šåœ¨æœåŠ¡ç«¯ç›´æ¥+1ï¼Œé˜²æ­¢å¤šäººå†²çª
            todo.increment('votes', 1);
            
            try {
                await todo.save(); // ä¿å­˜åˆ°äº‘ç«¯
                await loadData(); // é‡æ–°æ‹‰å–æœ€æ–°æ•°æ®
                alert(`æŠ•ç»™äº†ã€Š${movieName}ã€‹ï¼`);
            } catch (error) {
                alert("æŠ•ç¥¨å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        // æ›´æ–°å›¾è¡¨ç”»é¢
        function updateChart(dataMap) {
            // æŒ‰ç…§æˆ‘ä»¬éœ€è¦é¡ºåºæå–ç¥¨æ•°
            const votes = movieNames.map(name => dataMap[name] ? dataMap[name].votes : 0);

            const option = {
                tooltip: {},
                xAxis: { data: movieNames },
                yAxis: { minInterval: 1 }, // ä¿è¯Yè½´æ˜¯æ•´æ•°
                series: [{
                    name: 'ç¥¨æ•°',
                    type: 'bar',
                    data: votes,
                    itemStyle: { color: '#5470c6' },
                    label: { show: true, position: 'top' }
                }]
            };
            chartInstance.setOption(option);
            
            // é‡æ–°ç”ŸæˆæŒ‰é’®ï¼ˆä¸ºäº†ç»‘å®šæœ€æ–°çš„objectIdï¼‰
            const btnContainer = document.getElementById('btnContainer');
            btnContainer.innerHTML = ''; // æ¸…ç©ºæ—§æŒ‰é’®
            movieNames.forEach(name => {
                const btn = document.createElement('button');
                btn.innerText = name;
                // æ‰¾åˆ°å¯¹åº”çš„äº‘ç«¯ID
                const objId = dataMap[name].id;
                btn.onclick = () => vote(name, objId);
                btnContainer.appendChild(btn);
            });
        }

        // =========================================================
        // 3. å¯åŠ¨ç¨‹åº
        // =========================================================
        loadData();

        // ã€è‡ªåŠ¨åˆ·æ–°ã€‘æ¯éš”5ç§’è‡ªåŠ¨å»äº‘ç«¯çœ‹çœ‹æœ‰æ²¡æœ‰äººæŠ•ç¥¨
        setInterval(loadData, 5000);

    </script>
</body>
</html>
